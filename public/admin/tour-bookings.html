<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tour Bookings | Admin Panel | The Trip Connection</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ========== GLOBAL ADMIN STYLES (Retained) ========== */
*{ margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
body{ background:#f4f6fb; color:#1f2937; }
.admin-layout{ display:flex; min-height:100vh; }
.sidebar{ width:250px; background:#0f172a; color:#fff; padding:0; position:fixed; height:100vh; display: flex; flex-direction: column; }
.sidebar h2{ font-size:24px; font-weight: 800; padding:24px 20px; color: #fff; border-bottom: 1px solid #1e293b; }
.sidebar nav { padding: 20px 20px 0 20px; flex-grow: 1; }
.sidebar a{ display:flex; align-items:center; gap:12px; color:#cbd5e1; text-decoration:none; padding:12px 14px; border-radius:10px; margin-bottom:8px; transition:.3s; font-size:15px; }
.sidebar a i{ width:18px; }
.sidebar a:hover, .sidebar a.active{ background:#1e293b; color:#fff; font-weight: 600; }
.logout-btn-container { padding: 20px 20px 24px 20px; margin-top: auto; border-top: 1px solid #1e293b; }
.main{ margin-left:250px; padding:30px; width:100%; }
.topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
.menu-btn{ display:none; font-size:22px; cursor:pointer; }
.topbar h1{ font-size:30px; font-weight:700; }
.admin-profile{ display:flex; align-items:center; gap:10px; font-size: 16px; font-weight: 600; color: #0f172a; }
.admin-profile img{ width:42px; height:42px; border-radius:50%; object-fit:contain; background: #fff; border: 1px solid #ddd; }
.box{ background:#fff; padding:28px; border-radius:18px; box-shadow:0 15px 35px rgba(0,0,0,.08); }

/* ========== TABLE STYLES (Retained) ========== */
.data-table-container { overflow-x: auto; margin-top: 20px; }
.data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
.data-table th { background: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 13px; }
.data-table tr:hover { background: #f0f4f8; }

/* Status Badges */
.status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.status-New { background-color: #fef3c7; color: #b45309; } 
.status-Pending { background-color: #ffe0b2; color: #e65100; }
.status-Confirmed { background-color: #d4edda; color: #155724; }
.status-Cancelled { background-color: #f8d7da; color: #721c24; }

/* Load/Error Message */
#loadingMessage { text-align: center; padding: 50px; font-size: 18px; color: #666; }

/* ========== MOBILE (Retained) ========== */
@media(max-width:900px){
  .sidebar{ transform:translateX(-100%); transition:.3s; z-index:1000; }
  .sidebar.active{ transform:translateX(0); }
  .main{ margin-left:0; }
  .menu-btn{ display:block; }
  /* Hide less important columns on small screen */
  .data-table th:nth-child(4), .data-table td:nth-child(4) { display: none; } /* Hide Travel Date */
}
</style>
</head>

<body>

<div class="admin-layout">

  <!-- SIDEBAR (Tour Bookings Active) -->
  <aside class="sidebar" id="sidebar">
    <h2>Admin Panel</h2>
    
    <nav>
        <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
        <a href="manage-packages.html"><i class="fas fa-suitcase"></i> Packages</a>
        <a href="add-package.html"><i class="fas fa-plus-circle"></i> Add Package</a>
        <a href="manage-offers.html"><i class="fas fa-bullhorn"></i> Offer Popup</a>
        
        <a href="tour-bookings.html" class="active"><i class="fas fa-calendar-check"></i> Tour Bookings</a> <!-- ACTIVE -->
        <a href="car-enquiries.html"><i class="fas fa-car-side"></i> Car Enquiries</a>
        <a href="bus-enquiries.html"><i class="fas fa-bus-simple"></i> Bus Enquiries</a>
        
        <a href="contacts.html"><i class="fas fa-envelope"></i> Contacts</a>
        <a href="/"><i class="fas fa-globe"></i> View Website</a>
    </nav>
    
    <div class="logout-btn-container">
        <a href="/admin/login.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i>
        <h1>Tour Bookings</h1>
      </div>
      <div class="admin-profile">
        <span>Admin</span>
        <img src="/images/logofinal.png" alt="Admin Logo">
      </div>
    </div>
    
    <!-- CONTENT BOX: Tour Bookings List -->
    <div class="box">
        <h3>Recent Tour Package Bookings</h3>
        
        <div id="loadingMessage">
            <i class="fas fa-spinner fa-spin"></i> Loading bookings...
        </div>

        <div class="data-table-container" style="display:none;" id="tableContainer">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date Received</th>
                        <th>Client Details</th>
                        <th>Package Title</th>
                        <th>Travel Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tourBookingsTableBody">
                    <!-- Data will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
        <p id="noDataMessage" style="display:none; text-align:center; padding: 20px;">No tour bookings found.</p>
    </div>

  </main>

</div>

<script>
/* SIDEBAR TOGGLE (MOBILE) */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('active');
}

/* FETCH AND DISPLAY TOUR BOOKINGS */
async function loadTourBookings(){
    const tableBody = document.getElementById('tourBookingsTableBody');
    const loadingMessage = document.getElementById('loadingMessage');
    const tableContainer = document.getElementById('tableContainer');
    const noDataMessage = document.getElementById('noDataMessage');

    try{
        loadingMessage.style.display = 'block';

        // Fetching data from the API endpoint defined in server.js
        const res = await fetch('/api/admin/bookings'); 
        if (!res.ok) throw new Error('Failed to fetch data from API');
        
        // Assuming your server returns the array directly
        const bookings = await res.json(); 
        
        tableBody.innerHTML = ''; // Clear previous data

        if (bookings.length === 0) {
            noDataMessage.style.display = 'block';
            tableContainer.style.display = 'none';
        } else {
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                
                // Format the date the booking was received
                const receivedDate = new Date(booking.createdAt).toLocaleDateString('en-IN', {
                    day: '2-digit', month: 'short', year: 'numeric'
                });
                
                // --- FIX 1: Use 'package' and 'date' fields from Mongoose Schema ---
                const packageTitle = booking.package || 'Package Not Specified'; 
                // NOTE: Using booking.date as it matches your schema
                const travelDate = booking.date ? new Date(booking.date).toLocaleDateString('en-IN') : 'N/A'; 
                
                const currentStatus = booking.status || 'New';
                const statusClass = `status-${currentStatus}`;
                
                // --- FIX 2: Client Details Display with proper <br> and space ---
                row.innerHTML = `
                    <td>${receivedDate}</td>
                    <td>
                        <strong>${booking.name || 'N/A'}</strong><br>
                        <i class="fas fa-phone-alt"></i> ${booking.phone || 'N/A'}
                    </td>
                    <td>${packageTitle}</td>
                    <td>${travelDate}</td>
                    <td><span class="status-badge ${statusClass}">${currentStatus}</span></td>
                    <td>
                        <button onclick="changeStatus('${booking._id}')" title="Change Status" style="background: none; border: none; cursor: pointer; color: #0d6efd;"><i class="fas fa-edit"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            tableContainer.style.display = 'block';
        }

    }catch(err){
        console.error('Tour Bookings Load Error:', err);
        loadingMessage.innerText = '‚ùå Failed to load data. Check API connection or server logs.';
        loadingMessage.style.color = '#dc2626';
    } finally {
        loadingMessage.style.display = 'none';
    }
}

// Example function to update status (Backend logic needed)
function changeStatus(id) {
    if(confirm('Are you sure you want to mark this booking ID ' + id + ' as Contacted/Processed?')) {
        // You will implement a PATCH request here later
        alert('Status update requested for ID: ' + id);
        // After successful update, call loadTourBookings() again to refresh the table.
    }
}

loadTourBookings();
</script>

</body>
</html>